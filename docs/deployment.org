#+TITLE: Deployment Guide
#+AUTHOR: Telegram Note Bot
#+DATE: 2025

* Table of Contents :TOC:
- [[#quick-start-using-ghcr][Quick Start (Using GHCR)]]
- [[#automated-deployment][Automated Deployment]]
- [[#quick-deploy-aws-ec2][Quick Deploy (AWS EC2)]]
- [[#docker-deployment-from-source][Docker Deployment (From Source)]]
- [[#production-deployment][Production Deployment]]
- [[#https-setup][HTTPS Setup]]
- [[#management][Management]]

* Quick Start (Using GHCR)

*Recommended Method* - Deploy pre-built images from GitHub Container Registry.

** Prerequisites

- Docker installed
- Telegram Bot Token from [[https://t.me/botfather][@BotFather]]
- =.env= file configured

** One-Command Deploy

#+begin_src bash
# Download deployment script
curl -o deploy.sh https://raw.githubusercontent.com/mandoo180/telegram-note-bot/main/deploy.sh
chmod +x deploy.sh

# Configure environment
cat > .env <<EOF
TELEGRAM_BOT_TOKEN=your_token_here
DATABASE_PATH=/app/data/telegram_note.db
WEBAPP_BASE_URL=http://YOUR_IP:8000
WEBAPP_PORT=8000
TZ=Asia/Seoul
EOF

# Deploy!
./deploy.sh
#+end_src

The script will:
1. âœ… Pull latest image from =ghcr.io/mandoo180/telegram-note-bot=
2. âœ… Stop old container (if exists)
3. âœ… Initialize database (if needed)
4. âœ… Start new container
5. âœ… Verify deployment

** Manual Deploy (Using Docker)

#+begin_src bash
# Create data directory
mkdir -p data

# Configure environment
cp .env.example .env
nano .env  # Edit with your settings

# Pull image
docker pull ghcr.io/mandoo180/telegram-note-bot:latest

# Initialize database (first time only)
docker run --rm \
  -v $(pwd)/data:/app/data \
  -e DATABASE_PATH=/app/data/telegram_note.db \
  ghcr.io/mandoo180/telegram-note-bot:latest \
  python init_db.py

# Run bot
docker run -d \
  --name telegram-note-bot \
  --restart unless-stopped \
  --env-file .env \
  -e DATABASE_PATH=/app/data/telegram_note.db \
  -v $(pwd)/data:/app/data \
  ghcr.io/mandoo180/telegram-note-bot:latest

# View logs
docker logs -f telegram-note-bot
#+end_src

** Verify Deployment

In Telegram, send =/version= to your bot. You should see:

#+begin_example
ðŸ¤– Telegram Note Bot

Version: 1.0.0

A personal note-taking and scheduling bot with reminder notifications.
#+end_example

* Automated Deployment

Use the =deploy.sh= script for automated deployments.

** Basic Usage

#+begin_src bash
# Deploy latest version
./deploy.sh

# Deploy specific version
IMAGE_TAG=sha-abc123 ./deploy.sh

# View logs
./deploy.sh --logs

# Check status
./deploy.sh --status
#+end_src

** Environment Variables

Customize deployment with environment variables:

#+begin_src bash
# Deploy from different repository
GITHUB_USER=yourname REPO_NAME=your-bot ./deploy.sh

# Use different tag
IMAGE_TAG=v1.0.0 ./deploy.sh

# Custom data directory
DATA_DIR=/opt/telegram-note/data ./deploy.sh
#+end_src

** Updating the Bot

To update to the latest version:

#+begin_src bash
# Simply re-run the deployment script
./deploy.sh
#+end_src

The script will:
- Pull the latest image
- Stop the old container
- Start a new container with the same data volume
- Preserve your database and settings

** Authentication for Private Repositories

If your repository is private:

#+begin_src bash
# Create GitHub Personal Access Token with 'read:packages' scope
# Then authenticate:
echo $GITHUB_TOKEN | docker login ghcr.io -u mandoo180 --password-stdin

# Now deploy
./deploy.sh
#+end_src

** Available Image Tags

- =latest= - Latest build from main branch
- =main= - Same as latest
- =sha-<commit>= - Specific commit (e.g., =sha-abc1234=)
- =v*.*.*= - Release versions (e.g., =v1.0.0=)

#+begin_src bash
# View available tags
curl -s https://api.github.com/users/mandoo180/packages/container/telegram-note-bot/versions | jq '.[].metadata.container.tags'
#+end_src

* Quick Deploy (AWS EC2)

Deploy to AWS EC2 in under 15 minutes using pre-built images from GHCR.

** Prerequisites

- AWS account
- SSH key pair
- Telegram Bot Token from [[https://t.me/botfather][@BotFather]]

** Step 1: Launch EC2 Instance

1. Go to *AWS Console* â†’ *EC2* â†’ *Launch Instance*
2. Configure:
   - *AMI*: Ubuntu Server 22.04 LTS
   - *Type*: t2.micro (free tier eligible)
   - *Key pair*: Select or create new
   - *Security Group*: Allow ports 22, 80, 443
3. Click *Launch Instance*
4. Note your *Public IP address*

** Step 2: Setup EC2

SSH into your instance:

#+begin_src bash
ssh -i your-key.pem ubuntu@YOUR_EC2_IP
#+end_src

Run setup:

#+begin_src bash
# Update system
sudo apt-get update && sudo apt-get upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Log out and back in for group changes
exit
ssh -i your-key.pem ubuntu@YOUR_EC2_IP
#+end_src

** Step 3: Deploy Bot

#+begin_src bash
# Download deployment script
curl -o deploy.sh https://raw.githubusercontent.com/mandoo180/telegram-note-bot/main/deploy.sh
chmod +x deploy.sh

# Configure environment
cat > .env <<EOF
TELEGRAM_BOT_TOKEN=your_token_here
DATABASE_PATH=/app/data/telegram_note.db
WEBAPP_BASE_URL=http://YOUR_EC2_IP:8000
WEBAPP_PORT=8000
TZ=Asia/Seoul
EOF

# Edit with your actual values
nano .env

# Deploy!
./deploy.sh
#+end_src

The deployment script will:
1. Pull the latest image from GHCR (=ghcr.io/mandoo180/telegram-note-bot:latest=)
2. Initialize the database
3. Start the bot container
4. Verify the deployment

** Step 4: Test

1. Open Telegram
2. Message your bot: =/start=
3. Check version: =/version=
4. Try creating a note: =/note test=

âœ… *Your bot is now live!*

** Step 5: Auto-Start on Boot

Ensure the bot container restarts automatically on system reboot:

#+begin_src bash
# The deploy.sh script already sets --restart unless-stopped
# But you can also create a systemd service for more control:

sudo tee /etc/systemd/system/telegram-note.service > /dev/null <<'EOF'
[Unit]
Description=Telegram Note Bot
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/home/ubuntu
ExecStart=/usr/bin/docker start telegram-note-bot
ExecStop=/usr/bin/docker stop telegram-note-bot
User=ubuntu
Group=ubuntu

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable telegram-note
#+end_src

Note: The container is already configured with =--restart unless-stopped= so this is optional.

** Step 6: Update the Bot

To update to a new version:

#+begin_src bash
# Simply re-run the deployment script
./deploy.sh
#+end_src

This will pull the latest image and restart the bot while preserving your data.

* Docker Deployment (From Source)

Build and deploy from source code. Use this if you're developing or customizing the bot.

** Timezone Configuration (CRITICAL)

âš ï¸ *Docker containers default to UTC*. Set your timezone correctly for reminders to work!

*** Find Your Timezone

Common timezones:
- =Asia/Seoul= - South Korea
- =Asia/Tokyo= - Japan
- =America/New_York= - US Eastern
- =America/Los_Angeles= - US Pacific
- =Europe/London= - United Kingdom

[[https://en.wikipedia.org/wiki/List_of_tz_database_time_zones][Full timezone list]]

*** Configure Timezone

Edit =.env=:

#+begin_example
TZ=Asia/Seoul  # Change to YOUR timezone
#+end_example

*** Verify Timezone

After deployment:

#+begin_src bash
# Check container timezone (should show local time, NOT UTC)
docker exec telegram-note-bot date

# Check Python datetime
docker exec telegram-note-bot python -c "from datetime import datetime; print(datetime.now())"

# Run diagnostic
docker exec telegram-note-bot python check_reminders.py
#+end_src

All times should match your local timezone, not UTC!

** Deployment Steps

#+begin_src bash
# Clone
git clone <repo-url>
cd telegram-note

# Configure
cp .env.example .env
nano .env  # Set TELEGRAM_BOT_TOKEN and TZ

# Build
docker-compose build

# Initialize database
mkdir -p data
docker compose run --rm telegram-note python init_db.py

# Start
docker-compose up -d

# Check logs
docker-compose logs -f
#+end_src

** Docker Commands

#+begin_src bash
# View logs
docker logs -f telegram-note-bot
docker logs --tail 100 telegram-note-bot

# Restart
docker-compose restart

# Rebuild after code changes
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# Run diagnostic
docker exec telegram-note-bot python check_reminders.py

# Access database
docker exec -it telegram-note-bot sqlite3 /app/data/telegram_note.db

# Access container shell
docker exec -it telegram-note-bot /bin/bash

# Check timezone
docker exec telegram-note-bot date
docker exec telegram-note-bot cat /etc/timezone
#+end_src

* Production Deployment

** HTTPS Setup (Required for Web App)

Telegram Web Apps *require HTTPS*. Choose one option:

*** Option A: Nginx + Let's Encrypt

For production with a custom domain.

**** Install Nginx:

#+begin_src bash
sudo apt-get install -y nginx certbot python3-certbot-nginx
#+end_src

**** Configure DNS:

Point your domain (e.g., =bot.yourdomain.com=) to your server IP.

**** Create Nginx Configuration:

#+begin_src bash
sudo nano /etc/nginx/sites-available/telegram-note
#+end_src

Add:

#+begin_src nginx
server {
    listen 80;
    server_name bot.yourdomain.com;

    location / {
        proxy_pass http://localhost:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
#+end_src

**** Enable and Get SSL:

#+begin_src bash
sudo ln -s /etc/nginx/sites-available/telegram-note /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
sudo certbot --nginx -d bot.yourdomain.com
#+end_src

**** Update =.env=:

#+begin_example
WEBAPP_BASE_URL=https://bot.yourdomain.com
#+end_example

Restart bot:

#+begin_src bash
docker-compose restart
#+end_src

*** Option B: Cloudflare Tunnel

No domain required!

#+begin_src bash
# Install
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
sudo dpkg -i cloudflared-linux-amd64.deb

# Setup
cloudflared tunnel login
cloudflared tunnel create telegram-note
cloudflared tunnel route dns telegram-note bot

# Run
cloudflared tunnel run telegram-note
#+end_src

Update =.env= with the Cloudflare URL.

*** Option C: ngrok (Development Only)

#+begin_src bash
# Install
curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc
echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
sudo apt update && sudo apt install ngrok

# Authenticate
ngrok authtoken YOUR_TOKEN

# Run
ngrok http 8000
#+end_src

Copy HTTPS URL to =.env=.

** Security

*** Firewall:

#+begin_src bash
sudo apt-get install -y ufw
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw --force enable
#+end_src

*** File Permissions:

#+begin_src bash
chmod 600 .env
chmod 600 data/telegram_note.db
#+end_src

*** Regular Backups:

#+begin_src bash
# Daily backup cron job (runs at 2 AM)
crontab -e
#+end_src

Add:

#+begin_example
0 2 * * * cp /path/to/telegram-note/data/telegram_note.db /path/to/telegram-note/data/backup-$(date +\%Y\%m\%d).db
#+end_example

** Monitoring

*** Health Check:

#+begin_src bash
# Check status
docker ps | grep telegram-note
docker inspect telegram-note-bot | grep -A 5 Health

# Resource usage
docker stats telegram-note-bot

# Memory
free -h
#+end_src

*** Automated Monitoring:

Create =/usr/local/bin/check-telegram-bot.sh=:

#+begin_src bash
#!/bin/bash
if ! docker ps | grep -q telegram-note-bot; then
    echo "Bot is down! Restarting..."
    cd /path/to/telegram-note
    docker-compose up -d
    # Send alert (email, Slack, etc.)
fi
#+end_src

Add to crontab:

#+begin_example
,*/5 * * * * /usr/local/bin/check-telegram-bot.sh
#+end_example

* Management

** Common Commands

*** Using Deployment Script

#+begin_src bash
# Update to latest version
./deploy.sh

# View logs
./deploy.sh --logs

# Check status and version
./deploy.sh --status
#+end_src

*** Using Docker Commands

#+begin_src bash
# View logs
docker logs -f telegram-note-bot

# Restart container
docker restart telegram-note-bot

# Stop container
docker stop telegram-note-bot

# Start container
docker start telegram-note-bot

# Update to latest image
docker pull ghcr.io/mandoo180/telegram-note-bot:latest
docker stop telegram-note-bot
docker rm telegram-note-bot
./deploy.sh

# Backup database
cp data/telegram_note.db data/backup-$(date +%Y%m%d).db

# Restore database
cp data/backup-20250113.db data/telegram_note.db
docker restart telegram-note-bot
#+end_src

*** Using Docker Compose (Source Deployment)

#+begin_src bash
# View logs
docker-compose logs -f

# Restart
docker-compose restart

# Stop
docker-compose down

# Start
docker-compose up -d

# Update from git
git pull
docker-compose build --no-cache
docker-compose up -d
#+end_src

** Image Management

#+begin_src bash
# List local images
docker images | grep telegram-note

# Remove old images (cleanup)
docker image prune -a

# Pull specific version
docker pull ghcr.io/mandoo180/telegram-note-bot:v1.0.0

# Check current image
docker inspect telegram-note-bot | grep Image
#+end_src

** Database Maintenance

#+begin_src bash
# Access database
docker exec -it telegram-note-bot sqlite3 /app/data/telegram_note.db

# Inside sqlite3:
.tables
SELECT * FROM reminders;
DELETE FROM reminders WHERE sent = TRUE AND sent_at < datetime('now', '-30 days');
VACUUM;
.quit
#+end_src

** Testing Reminders

Create a test reminder that fires in 2 minutes:

1. =/schedule test-reminder=
2. Set start time: (current time + 3 minutes)
3. Set reminder: 1 minute before
4. Save

Monitor:

#+begin_src bash
docker logs -f telegram-note-bot | grep -i reminder
#+end_src

You should see:
- =Scheduled reminder for schedule test-reminder at ...=
- (After 2 min) =Sent reminder for schedule test-reminder to user ...=

* Cost Estimation

** AWS EC2 Deployment:

- *EC2 t2.micro*: ~$8.50/month (Free tier: 750 hours/month for 12 months)
- *EBS Storage 8GB*: ~$0.80/month
- *Data Transfer*: Usually < $1/month
- *Domain (optional)*: ~$12/year
- *Total*: ~$10/month (or FREE for first year)

** Other Cloud Providers:

- *DigitalOcean*: $6/month droplet
- *Linode*: $5/month Nanode
- *Hetzner*: â‚¬4/month CX11

* Next Steps

After deployment:

1. âœ… Bot is running
2. ðŸ”’ Setup HTTPS for Web App
3. ðŸ’¾ Configure automatic backups
4. ðŸ“Š Setup monitoring
5. ðŸ”„ Configure CI/CD (optional)

For troubleshooting, see [[file:troubleshooting.org][Troubleshooting Guide]].
