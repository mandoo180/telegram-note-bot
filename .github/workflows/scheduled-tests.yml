name: Scheduled Tests

on:
  schedule:
    # Run every day at 2 AM UTC (11 AM KST)
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  test:
    name: Daily Health Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test database initialization
        run: |
          python init_db.py
          test -f telegram_note.db || exit 1

      - name: Test imports and modules
        run: |
          cd src && python -c "from main import TelegramNoteBot" && cd ..
          cd src && python -c "from models.database import Database" && cd ..
          cd src && python -c "from services.reminder_service import ReminderService" && cd ..
          python check_reminders.py

      - name: Test Docker build
        run: |
          docker build -t telegram-note:test .
          mkdir -p data
          docker run --rm \
            -e DATABASE_PATH=/app/data/telegram_note.db \
            -v $(pwd)/data:/app/data \
            telegram-note:test python init_db.py

      - name: Security scan
        run: |
          pip install safety
          safety check --json || true
        continue-on-error: true

      - name: Create summary
        if: always()
        run: |
          echo "## Daily Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Python version: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- Date: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: test
    if: failure()

    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Scheduled Test] Daily health check failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `The daily health check workflow failed.

            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            **Date:** ${new Date().toISOString()}

            Please investigate the failure.`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,health-check'
            });

            const existingIssue = issues.data.find(issue => issue.title === title);

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['automated', 'health-check', 'bug']
              });
            }
